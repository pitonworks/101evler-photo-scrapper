<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>101evler Tools</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 40px 20px;
    }
    .container {
      width: 100%;
      max-width: 700px;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 16px;
      color: #1a1a1a;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 24px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: #888;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: color 0.2s, border-color 0.2s;
      user-select: none;
    }
    .tab:hover { color: #555; }
    .tab.active {
      color: #4a90d9;
      border-bottom-color: #4a90d9;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 6px;
      color: #555;
    }
    input[type="text"], input[type="email"], input[type="password"], input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      background: #fff;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: #4a90d9;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #4a90d9;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
    }
    button:hover { background: #3a7bc8; }
    button:disabled {
      background: #a0c4e8;
      cursor: not-allowed;
    }
    .log-area {
      margin-top: 16px;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 6px;
      padding: 16px;
      font-family: "Cascadia Code", "Fira Code", "Consolas", monospace;
      font-size: 0.825rem;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-area .progress { color: #9cdcfe; }
    .log-area .done { color: #6a9955; font-weight: bold; }
    .log-area .error { color: #f44747; }
    .log-area .phase { color: #dcdcaa; font-weight: bold; }
    .log-area .meta { color: #ce9178; }

    .input-row {
      display: flex;
      gap: 8px;
    }
    .input-row input[type="text"] { flex: 1; }
    .btn-browse {
      width: auto;
      padding: 10px 16px;
      margin-top: 0;
      white-space: nowrap;
      font-size: 0.875rem;
    }

    .checkbox-group { margin-bottom: 12px; }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #555;
    }
    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #e67e22;
    }

    .btn-transfer {
      background: #e67e22;
    }
    .btn-transfer:hover { background: #d35400; }
    .btn-transfer:disabled {
      background: #f0c08a;
      cursor: not-allowed;
    }

    /* Queue styles */
    .queue-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .queue-controls button {
      flex: 1;
      margin-top: 0;
    }
    .btn-start { background: #27ae60; }
    .btn-start:hover { background: #219a52; }
    .btn-start:disabled { background: #a3d9b1; }
    .btn-stop { background: #c0392b; }
    .btn-stop:hover { background: #a93226; }
    .btn-stop:disabled { background: #d9a5a0; }

    .queue-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 0.875rem;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #bbb;
      flex-shrink: 0;
    }
    .status-dot.idle { background: #bbb; }
    .status-dot.running { background: #27ae60; animation: pulse 1.5s infinite; }
    .status-dot.stopping { background: #e67e22; animation: pulse 1s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .status-text { flex: 1; color: #555; }
    .status-counts { color: #888; font-size: 0.8rem; }

    .queue-list {
      margin-bottom: 16px;
    }
    .queue-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      transition: border-color 0.2s;
    }
    .queue-item.processing { border-color: #4a90d9; background: #f0f7ff; }
    .queue-item.done { opacity: 0.6; }
    .queue-item.failed { border-color: #e74c3c; background: #fdf2f2; }

    .qi-icon {
      font-size: 1rem;
      flex-shrink: 0;
      width: 20px;
      text-align: center;
    }
    .qi-url {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #333;
    }
    .qi-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    .qi-actions button {
      width: auto;
      padding: 4px 10px;
      margin: 0;
      font-size: 0.75rem;
      border-radius: 4px;
    }
    .btn-retry { background: #e67e22; }
    .btn-retry:hover { background: #d35400; }
    .btn-delete { background: #888; }
    .btn-delete:hover { background: #666; }

    .queue-add-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .queue-add-row input { flex: 1; }
    .btn-add {
      width: auto;
      padding: 10px 20px;
      margin-top: 0;
      white-space: nowrap;
    }

    .queue-empty {
      text-align: center;
      padding: 24px;
      color: #aaa;
      font-size: 0.9rem;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      margin-bottom: 16px;
    }
    .pagination button {
      width: auto;
      padding: 6px 12px;
      margin: 0;
      font-size: 0.8rem;
      border-radius: 4px;
      background: #e8e8e8;
      color: #333;
    }
    .pagination button:hover { background: #d0d0d0; }
    .pagination button.active { background: #4a90d9; color: #fff; }
    .pagination button:disabled { background: #f0f0f0; color: #bbb; cursor: not-allowed; }
    .pagination .page-info {
      font-size: 0.8rem;
      color: #888;
      padding: 0 8px;
    }

    /* Dry run result */
    .metadata-preview {
      margin-top: 16px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 0.85rem;
      display: none;
    }
    .metadata-preview h3 {
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: #4a90d9;
    }
    .metadata-preview .meta-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .metadata-preview .meta-row:last-child { border-bottom: none; }
    .metadata-preview .meta-label { color: #888; }
    .metadata-preview .meta-value { font-weight: 500; }
    .metadata-preview h4 {
      font-size: 0.85rem;
      margin-bottom: 6px;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #fff;
      border-radius: 10px;
      width: 90%;
      max-width: 520px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { font-size: 1.1rem; }
    .modal-close {
      width: auto;
      padding: 4px 10px;
      margin: 0;
      background: transparent;
      color: #888;
      font-size: 1.3rem;
      line-height: 1;
    }
    .modal-close:hover { background: #f0f0f0; color: #333; }
    .modal-path {
      padding: 10px 20px;
      background: #f8f8f8;
      font-size: 0.8rem;
      color: #666;
      font-family: monospace;
      word-break: break-all;
      border-bottom: 1px solid #eee;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      min-height: 200px;
      max-height: 45vh;
    }
    .folder-item {
      padding: 10px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      transition: background 0.15s;
    }
    .folder-item:hover { background: #f0f5ff; }
    .folder-item.parent { color: #888; font-style: italic; }
    .shortcuts-bar {
      display: flex;
      gap: 6px;
      padding: 10px 20px;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
    }
    .shortcut-btn {
      width: auto;
      padding: 5px 12px;
      margin: 0;
      font-size: 0.75rem;
      border-radius: 4px;
      background: #e8e8e8;
      color: #333;
    }
    .shortcut-btn:hover { background: #d0d0d0; }
    .shortcut-btn.active { background: #4a90d9; color: #fff; }
    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .mkdir-row {
      display: flex;
      gap: 8px;
    }
    .mkdir-row input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    .mkdir-row input:focus { outline: none; border-color: #4a90d9; }
    .btn-mkdir {
      width: auto;
      padding: 8px 14px;
      margin: 0;
      font-size: 0.8rem;
      background: #5cb85c;
    }
    .btn-mkdir:hover { background: #4cae4c; }
    .btn-select {
      width: 100%;
      padding: 10px;
      margin: 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>101evler Tools</h1>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('scraper')">Photo Scraper</div>
      <div class="tab" onclick="switchTab('transfer')">Listing Transfer</div>
      <div class="tab" onclick="switchTab('queue')">Queue</div>
    </div>

    <!-- Tab 1: Photo Scraper -->
    <div id="tab-scraper" class="tab-content active">
      <div class="form-group">
        <label for="url">101evler Link</label>
        <input type="text" id="url" placeholder="https://www.101evler.com/...">
      </div>
      <div class="form-group">
        <label for="outputDir">Download Folder</label>
        <div class="input-row">
          <input type="text" id="outputDir" value="./downloads">
          <button class="btn-browse" onclick="openBrowser()">Browse</button>
        </div>
      </div>
      <button id="startBtn" onclick="startScrape()">Start</button>
      <div id="log" class="log-area"></div>
    </div>

    <!-- Tab 2: Listing Transfer (single) -->
    <div id="tab-transfer" class="tab-content">
      <div class="form-group">
        <label for="transferUrl">101evler Link</label>
        <input type="text" id="transferUrl" placeholder="https://www.101evler.com/...">
      </div>
      <div class="form-group">
        <label for="ggEmail">gelgezgor.com Email</label>
        <input type="email" id="ggEmail" placeholder="email@example.com">
      </div>
      <div class="form-group">
        <label for="ggPassword">gelgezgor.com Password</label>
        <input type="password" id="ggPassword" placeholder="Password">
      </div>
      <div class="form-group">
        <label for="maxPhotos">Max Foto (bos = hepsi)</label>
        <input type="text" id="maxPhotos" placeholder="orn: 5">
      </div>
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="dryRunCheck">
          <span>Dry Run (formu doldur ama gonderme)</span>
        </label>
      </div>
      <button id="transferBtn" class="btn-transfer" onclick="startTransfer()">Transfer Listing</button>
      <div id="dryRunResult" class="metadata-preview" style="display:none">
        <h3>Dry Run Sonucu</h3>
        <div id="dryRunProfile"></div>
        <h4 style="margin-top:12px;font-size:0.85rem;color:#e67e22">Doldurulan Alanlar</h4>
        <div id="dryRunValues"></div>
        <div id="dryRunWarnings" style="display:none">
          <h4 style="margin-top:12px;font-size:0.85rem;color:#e74c3c">Uyarilar</h4>
          <div id="dryRunWarningsList"></div>
        </div>
        <div id="dryRunSkipped" style="display:none">
          <h4 style="margin-top:12px;font-size:0.85rem;color:#888">Atlanan Alanlar</h4>
          <div id="dryRunSkippedList"></div>
        </div>
      </div>
      <div id="transferLog" class="log-area"></div>
    </div>

    <!-- Tab 3: Queue -->
    <div id="tab-queue" class="tab-content">
      <!-- Credentials -->
      <div class="form-group">
        <label for="qEmail">gelgezgor.com Email</label>
        <input type="email" id="qEmail" placeholder="email@example.com">
      </div>
      <div class="form-group">
        <label for="qPassword">gelgezgor.com Password</label>
        <input type="password" id="qPassword" placeholder="Password">
      </div>
      <div style="display:flex;gap:12px;margin-bottom:16px">
        <div class="form-group" style="flex:1;margin-bottom:0">
          <label for="qMaxPhotos">Max Foto</label>
          <input type="number" id="qMaxPhotos" placeholder="hepsi">
        </div>
        <div class="form-group" style="flex:1;margin-bottom:0">
          <label class="checkbox-label" style="margin-top:24px">
            <input type="checkbox" id="qDryRun">
            <span>Dry Run</span>
          </label>
        </div>
      </div>

      <!-- Add URL -->
      <div class="queue-add-row">
        <input type="text" id="qUrlInput" placeholder="https://www.101evler.com/... (birden fazla icin virgul ile ayirin)">
        <button class="btn-add" onclick="addToQueue()">Ekle</button>
      </div>

      <!-- Controls -->
      <div class="queue-controls">
        <button class="btn-start" id="qStartBtn" onclick="startQueue()">Islemeyi Baslat</button>
        <button class="btn-stop" id="qStopBtn" onclick="stopQueue()" disabled>Durdur</button>
      </div>

      <!-- Status -->
      <div class="queue-status">
        <div class="status-dot" id="qStatusDot"></div>
        <span class="status-text" id="qStatusText">Bosta</span>
        <span class="status-counts" id="qStatusCounts"></span>
      </div>

      <!-- Queue list -->
      <div class="queue-list" id="queueList">
        <div class="queue-empty">Kuyrukta ilan yok</div>
      </div>
      <div class="pagination" id="queuePagination" style="display:none"></div>

      <!-- Live log -->
      <div id="queueLog" class="log-area"></div>
    </div>
  </div>

  <!-- Folder Browser Modal -->
  <div class="modal-overlay" id="folderModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Select Folder</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="shortcuts-bar" id="shortcutsBar"></div>
      <div class="modal-path" id="modalPath"></div>
      <div class="modal-body" id="folderList"></div>
      <div class="modal-footer">
        <div class="mkdir-row">
          <input type="text" id="newFolderName" placeholder="New folder name...">
          <button class="btn-mkdir" onclick="createFolder()">Create</button>
        </div>
        <button class="btn-select" onclick="selectFolder()">Select This Folder</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== Tab switching ====================
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      const tabs = document.querySelectorAll('.tab');
      if (tabName === 'scraper') tabs[0].classList.add('active');
      else if (tabName === 'transfer') tabs[1].classList.add('active');
      else if (tabName === 'queue') tabs[2].classList.add('active');

      // Load queue data when switching to queue tab
      if (tabName === 'queue') loadQueueData();
    }

    // ==================== Folder Browser ====================
    let currentBrowsePath = "";

    async function openBrowser() {
      document.getElementById("folderModal").classList.add("active");
      const lastPath = document.getElementById("outputDir").value.trim();
      await loadFolder(lastPath || undefined);
    }

    function closeModal() {
      document.getElementById("folderModal").classList.remove("active");
    }

    function renderShortcuts(drives) {
      const bar = document.getElementById("shortcutsBar");
      bar.innerHTML = "";
      const homeBtn = document.createElement("button");
      homeBtn.className = "shortcut-btn";
      homeBtn.textContent = "Home";
      homeBtn.onclick = () => loadFolder();
      bar.appendChild(homeBtn);
      for (const drive of drives) {
        const btn = document.createElement("button");
        btn.className = "shortcut-btn";
        btn.textContent = drive.label;
        btn.onclick = () => loadFolder(drive.path);
        bar.appendChild(btn);
      }
    }

    async function loadFolder(dirPath) {
      const params = dirPath ? "?path=" + encodeURIComponent(dirPath) : "";
      try {
        const res = await fetch("/browse" + params);
        const data = await res.json();
        if (data.error) {
          if (dirPath) return loadFolder();
          alert(data.error);
          return;
        }
        currentBrowsePath = data.current;
        document.getElementById("modalPath").textContent = data.current;
        if (data.drives) renderShortcuts(data.drives);
        const list = document.getElementById("folderList");
        list.innerHTML = "";
        const parent = document.createElement("div");
        parent.className = "folder-item parent";
        parent.textContent = ".. (parent folder)";
        parent.onclick = () => {
          const parentPath = currentBrowsePath.replace(/[/\\][^/\\]*$/, "") || "/";
          loadFolder(parentPath);
        };
        list.appendChild(parent);
        for (const name of data.folders) {
          const item = document.createElement("div");
          item.className = "folder-item";
          item.innerHTML = "&#128193; " + name;
          item.onclick = () => loadFolder(currentBrowsePath + "/" + name);
          list.appendChild(item);
        }
      } catch (err) {
        alert("Failed to browse: " + err.message);
      }
    }

    async function createFolder() {
      const name = document.getElementById("newFolderName").value.trim();
      if (!name) return;
      try {
        const res = await fetch("/mkdir", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ dirPath: currentBrowsePath + "/" + name })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        document.getElementById("newFolderName").value = "";
        await loadFolder(currentBrowsePath);
      } catch (err) {
        alert("Failed to create folder: " + err.message);
      }
    }

    function selectFolder() {
      document.getElementById("outputDir").value = currentBrowsePath;
      closeModal();
    }

    document.getElementById("folderModal").addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    // ==================== Log helpers ====================
    function appendLog(logEl, text, className) {
      logEl.style.display = "block";
      const line = document.createElement("div");
      line.textContent = text;
      if (className) line.className = className;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ==================== SSE stream reader ====================
    async function readSSEStream(response, logEl, handlers) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop();

        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;
          try {
            const data = JSON.parse(line.slice(6));
            if (handlers[data.type]) {
              handlers[data.type](data);
            } else if (data.type === "progress") {
              appendLog(logEl, data.message, "progress");
            }
          } catch (e) {
            // ignore parse errors
          }
        }
      }
    }

    // ==================== Photo Scraper ====================
    async function startScrape() {
      const url = document.getElementById("url").value.trim();
      const outputDir = document.getElementById("outputDir").value.trim();
      const btn = document.getElementById("startBtn");
      const log = document.getElementById("log");

      if (!url) { alert("Please enter a URL."); return; }
      if (!outputDir) { alert("Please enter a download folder."); return; }

      log.style.display = "block";
      log.innerHTML = "";
      btn.disabled = true;
      btn.textContent = "Running...";

      try {
        const response = await fetch("/scrape", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, outputDir })
        });

        await readSSEStream(response, log, {
          done: (data) => appendLog(log, `Completed: ${data.downloaded}/${data.total} photos downloaded.`, "done"),
          error: (data) => appendLog(log, `Error: ${data.message}`, "error"),
        });
      } catch (err) {
        appendLog(log, `Connection error: ${err.message}`, "error");
      }

      btn.disabled = false;
      btn.textContent = "Start";
    }

    // ==================== Listing Transfer (single) ====================
    // Save/restore email from localStorage
    const savedEmail = localStorage.getItem("gg_email");
    if (savedEmail) {
      document.addEventListener("DOMContentLoaded", () => {
        const el = document.getElementById("ggEmail");
        if (el) el.value = savedEmail;
        const qEl = document.getElementById("qEmail");
        if (qEl) qEl.value = savedEmail;
      });
      const emailEl = document.getElementById("ggEmail");
      if (emailEl) emailEl.value = savedEmail;
      const qEmailEl = document.getElementById("qEmail");
      if (qEmailEl) qEmailEl.value = savedEmail;
    }

    function showDryRunResult(data) {
      const container = document.getElementById("dryRunResult");
      container.style.display = "block";

      document.getElementById("dryRunProfile").innerHTML =
        `<div class="meta-row"><span class="meta-label">Profil</span><span class="meta-value">${data.profile.label}</span></div>` +
        `<div class="meta-row"><span class="meta-label">Tip</span><span class="meta-value">${data.profile.type}</span></div>` +
        `<div class="meta-row"><span class="meta-label">Form alanlari</span><span class="meta-value">${data.discoveredFields.length} kesfedildi</span></div>`;

      const valuesHtml = Object.entries(data.mappedValues).map(([key, val]) => {
        const filled = data.filledFields.includes(key);
        const displayVal = key === "aciklama" ? val.substring(0, 80) + "..." : val;
        return `<div class="meta-row">
          <span class="meta-label">${key} ${filled ? "+" : "-"}</span>
          <span class="meta-value" style="color:${filled ? "#27ae60" : "#e74c3c"}">${displayVal}</span>
        </div>`;
      }).join("");
      document.getElementById("dryRunValues").innerHTML = valuesHtml;

      const warningsEl = document.getElementById("dryRunWarnings");
      if (data.warnings && data.warnings.length > 0) {
        warningsEl.style.display = "block";
        document.getElementById("dryRunWarningsList").innerHTML =
          data.warnings.map(w => `<div class="meta-row"><span class="meta-label" style="color:#e74c3c">${w}</span></div>`).join("");
      } else {
        warningsEl.style.display = "none";
      }

      const skippedEl = document.getElementById("dryRunSkipped");
      if (data.skippedFields && data.skippedFields.length > 0) {
        skippedEl.style.display = "block";
        document.getElementById("dryRunSkippedList").innerHTML =
          data.skippedFields.map(f => `<div class="meta-row"><span class="meta-label">${f}</span></div>`).join("");
      } else {
        skippedEl.style.display = "none";
      }
    }

    async function startTransfer() {
      const url = document.getElementById("transferUrl").value.trim();
      const email = document.getElementById("ggEmail").value.trim();
      const password = document.getElementById("ggPassword").value.trim();
      const dryRun = document.getElementById("dryRunCheck").checked;
      const maxPhotos = document.getElementById("maxPhotos").value.trim();
      const btn = document.getElementById("transferBtn");
      const log = document.getElementById("transferLog");
      const dryRunResult = document.getElementById("dryRunResult");

      if (!url) { alert("Please enter a 101evler URL."); return; }
      if (!email) { alert("Please enter gelgezgor email."); return; }
      if (!password) { alert("Please enter gelgezgor password."); return; }

      localStorage.setItem("gg_email", email);

      log.style.display = "block";
      log.innerHTML = "";
      dryRunResult.style.display = "none";
      btn.disabled = true;
      btn.textContent = dryRun ? "Running Dry Run..." : "Transferring...";

      try {
        const response = await fetch("/transfer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, email, password, dryRun, maxPhotos: maxPhotos || undefined })
        });

        await readSSEStream(response, log, {
          phase: (data) => appendLog(log, `--- ${data.message} ---`, "phase"),
          scraped: (data) => {
            appendLog(log, "Metadata scraped successfully!", "done");
          },
          dryrun: (data) => {
            appendLog(log, "Dry run completed!", "done");
            showDryRunResult(data);
          },
          done: (data) => {
            if (data.dryRun) {
              appendLog(log, "Dry run finished - form was NOT submitted", "done");
            } else if (data.success) {
              appendLog(log, `Listing posted successfully!`, "done");
              if (data.listingUrl) {
                appendLog(log, `URL: ${data.listingUrl}`, "done");
              }
            } else {
              appendLog(log, `Transfer completed with warnings: ${data.error || "check gelgezgor.com"}`, "error");
              if (data.listingUrl) {
                appendLog(log, `Result URL: ${data.listingUrl}`, "progress");
              }
            }
          },
          error: (data) => appendLog(log, `Error: ${data.message}`, "error"),
        });
      } catch (err) {
        appendLog(log, `Connection error: ${err.message}`, "error");
      }

      btn.disabled = false;
      btn.textContent = "Transfer Listing";
    }

    // ==================== Queue ====================
    let queueSSE = null;
    let currentPage = 1;
    const PAGE_SIZE = 30;

    function getStatusIcon(status) {
      switch (status) {
        case "done": return '<span style="color:#27ae60">&#x25CF;</span>';
        case "processing": return '<span style="color:#4a90d9">&#x25C9;</span>';
        case "pending": return '<span style="color:#bbb">&#x25CB;</span>';
        case "failed": return '<span style="color:#e74c3c">&#x2715;</span>';
        default: return "?";
      }
    }

    function renderQueueList(items) {
      const list = document.getElementById("queueList");
      if (!items || items.length === 0) {
        list.innerHTML = '<div class="queue-empty">Kuyrukta ilan yok</div>';
        return;
      }

      list.innerHTML = items.map(item => {
        const shortUrl = item.url.replace("https://www.101evler.com/", "");
        let actions = "";
        if (item.status === "pending") {
          actions = `<button class="btn-delete" onclick="deleteQueueItem('${item.id}')">Sil</button>`;
        } else if (item.status === "failed") {
          actions = `<button class="btn-retry" onclick="retryQueueItem('${item.id}')">Tekrar</button>` +
            `<button class="btn-delete" onclick="deleteQueueItem('${item.id}')">Sil</button>`;
        }
        const errorInfo = item.error ? ` title="${item.error}"` : "";
        return `<div class="queue-item ${item.status}"${errorInfo}>
          <span class="qi-icon">${getStatusIcon(item.status)}</span>
          <span class="qi-url" title="${item.url}">${shortUrl}</span>
          <span style="font-size:0.75rem;color:#888;text-transform:uppercase">${item.status}</span>
          <span class="qi-actions">${actions}</span>
        </div>`;
      }).join("");
    }

    function updateQueueStatus(status) {
      const dot = document.getElementById("qStatusDot");
      const text = document.getElementById("qStatusText");
      const counts = document.getElementById("qStatusCounts");
      const startBtn = document.getElementById("qStartBtn");
      const stopBtn = document.getElementById("qStopBtn");

      if (status.running) {
        dot.className = "status-dot running";
        text.textContent = "Isleniyor...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } else {
        dot.className = "status-dot idle";
        text.textContent = "Bosta";
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      const parts = [];
      if (status.done) parts.push(status.done + " tamamlandi");
      if (status.processing) parts.push(status.processing + " isleniyor");
      if (status.pending) parts.push(status.pending + " bekliyor");
      if (status.failed) parts.push(status.failed + " basarisiz");
      counts.textContent = parts.length ? parts.join(" / ") : "";
    }

    async function safeJson(res) {
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error(res.ok ? "Invalid JSON response" : `Server error ${res.status}`);
      }
    }

    function renderPagination(pagination) {
      const container = document.getElementById("queuePagination");
      if (!pagination || pagination.totalPages <= 1) {
        container.style.display = "none";
        return;
      }
      container.style.display = "flex";
      const { page, totalPages, total } = pagination;

      let html = `<button ${page <= 1 ? "disabled" : ""} onclick="goToPage(${page - 1})">&laquo;</button>`;

      // Show page buttons with ellipsis
      const maxButtons = 5;
      let startPage = Math.max(1, page - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      if (startPage > 1) {
        html += `<button onclick="goToPage(1)">1</button>`;
        if (startPage > 2) html += `<span class="page-info">...</span>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="${i === page ? "active" : ""}" onclick="goToPage(${i})">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<span class="page-info">...</span>`;
        html += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
      }

      html += `<button ${page >= totalPages ? "disabled" : ""} onclick="goToPage(${page + 1})">&raquo;</button>`;
      html += `<span class="page-info">${total} ilan</span>`;

      container.innerHTML = html;
    }

    function goToPage(page) {
      currentPage = page;
      loadQueueData();
    }

    async function loadQueueData() {
      try {
        const res = await fetch(`/queue?page=${currentPage}&limit=${PAGE_SIZE}`);
        const data = await safeJson(res);
        renderQueueList(data.items);
        updateQueueStatus(data.status);
        renderPagination(data.pagination);
      } catch (err) {
        console.error("Failed to load queue:", err);
      }
    }

    function connectQueueSSE() {
      if (queueSSE) {
        queueSSE.close();
      }
      queueSSE = new EventSource("/queue/progress");
      queueSSE.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          const logEl = document.getElementById("queueLog");

          switch (data.event) {
            case "worker-status":
              updateQueueStatus(data);
              if (data.status === "stopped" || data.status === "idle") {
                loadQueueData();
              }
              break;
            case "item-start":
              appendLog(logEl, `--- Isleniyor: ${data.url} ---`, "phase");
              loadQueueData();
              break;
            case "item-done":
              appendLog(logEl, `Tamamlandi: ${data.itemId}`, "done");
              loadQueueData();
              break;
            case "item-failed":
              appendLog(logEl, `Basarisiz: ${data.itemId} - ${data.error}`, "error");
              loadQueueData();
              break;
            case "log":
              appendLog(logEl, data.message, "progress");
              break;
            case "queue-updated":
              loadQueueData();
              break;
          }
        } catch (e) {
          // ignore
        }
      };
      queueSSE.onerror = () => {
        // EventSource will auto-reconnect
      };
    }

    async function addToQueue() {
      const input = document.getElementById("qUrlInput");
      const raw = input.value.trim();
      if (!raw) { alert("URL girin."); return; }

      // Split by comma, newline, or space (for multiple URLs)
      const urls = raw.split(/[,\n\s]+/).map(u => u.trim()).filter(u => u.startsWith("http"));
      if (urls.length === 0) { alert("Gecerli URL girin."); return; }

      try {
        const res = await fetch("/queue", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ urls })
        });
        const data = await safeJson(res);
        if (data.error) { alert(data.error); return; }
        input.value = "";
        loadQueueData();
      } catch (err) {
        alert("Hata: " + err.message);
      }
    }

    async function deleteQueueItem(id) {
      try {
        const res = await fetch("/queue/" + id, { method: "DELETE" });
        const data = await safeJson(res);
        if (data.error) { alert(data.error); return; }
        loadQueueData();
      } catch (err) {
        alert("Hata: " + err.message);
      }
    }

    async function retryQueueItem(id) {
      try {
        const res = await fetch("/queue/" + id + "/retry", { method: "POST" });
        const data = await safeJson(res);
        if (data.error) { alert(data.error); return; }
        loadQueueData();
      } catch (err) {
        alert("Hata: " + err.message);
      }
    }

    async function startQueue() {
      const email = document.getElementById("qEmail").value.trim();
      const password = document.getElementById("qPassword").value.trim();
      const dryRun = document.getElementById("qDryRun").checked;
      const maxPhotos = document.getElementById("qMaxPhotos").value.trim();

      if (!email) { alert("Email girin."); return; }
      if (!password) { alert("Sifre girin."); return; }

      localStorage.setItem("gg_email", email);

      // Clear log
      const logEl = document.getElementById("queueLog");
      logEl.style.display = "block";
      logEl.innerHTML = "";

      try {
        const res = await fetch("/queue/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, dryRun, maxPhotos: maxPhotos || undefined })
        });
        const data = await safeJson(res);
        if (data.error) { alert(data.error); return; }
      } catch (err) {
        alert("Hata: " + err.message);
      }
    }

    async function stopQueue() {
      try {
        const res = await fetch("/queue/stop", { method: "POST" });
        const data = await safeJson(res);
        if (data.error) { alert(data.error); return; }
        document.getElementById("qStopBtn").disabled = true;
      } catch (err) {
        alert("Hata: " + err.message);
      }
    }

    // Initialize SSE connection for queue
    connectQueueSSE();
    // Load initial queue data
    loadQueueData();
  </script>
</body>
</html>
